## 조인

두 개 이상의 테이블이나 데이터 베이스를 연결하여 데이터를 검색하는 방법



#### 내부 조인

- 교차 조인

- 등가/동등/동일 조인

- 비등가 조인

- 자연 조인

#### 외부 조인

- 완전 외부 조인
- 왼쪽 조인
- 오른쪽 조인

#### 셀프 조인

#### 안티 조인

#### 세미 조인



#### 내부조인 **(INNER JOIN)**

##### 교차조인 **(CROSS JOIN - CARTESIN PRODUCT)**

두 테이블의 곱집합을 한 결과

![](https://t1.daumcdn.net/cfile/tistory/99FE21365C0D1ECE14)

```
SELECT *
FROM employees, dept_emp;
```

##### 동일 조인**(EQUI JOIN)**

동등 비교를 하는 조인 내부 조인과 동일함.

![](https://t1.daumcdn.net/cfile/tistory/9940AD365C0D1ECF08)

```
SELECT *
FROM employees, dept_emp
WHERE employees.emp_no = dept_emp.emp_no;
```

##### 비등가 조인**(NON-EQUI JOIN)**

동등 비교가 아닌 조건문이 크거나 작거나 같지 않은 비교등을 사용하면 비등가 조인이라 함

```
SELECT *
FROM employees, departments
WHERE employees.emp_no between 10003 and 10004;
```

##### 자연 조인 **(NATURAL JOIN)**

두 테이블의 컬럼명이 같은 기준으로 조인 조건문이 암시적으로 일어나는 내부 조인

```
SELECT *
FROM employees NATURAL JOIN dept_emp;
```



##### 외부조인 **(OUTER JOIN)**

왼쪽 외부 조인 **(LEFT OUTER JOIN)**

테이블 A의 모든 데이터와 테이블 B와 매칭이 되는 레코드를 포함하는 조인

![](https://t1.daumcdn.net/cfile/tistory/994ECC3F5C0D1ED21C)

```
SELECT *
FROM employees
  LEFT OUTER JOIN departments
    ON employees.dept_no = departments.dept_no;
```

##### 오른쪽 외부 조인 **(RIGHT OUTER JOIN)**

테이블 B의 모든 데이터와 테이블 A와 매칭이되는 레코드를 포함하는 조인

![](https://t1.daumcdn.net/cfile/tistory/99943F4D5C0D1ED536)

```
SELECT *
FROM table1
  RIGHT OUTER JOIN table2
    ON table1.n = table2.n;
```

##### 완전 외부 조인 **(FULL OUTER JOIN)**

MySQL에서는 명시적인 SQL 구문은 지원하지 않지만, UNION을 사용해서 완전 외부 조인을 할 수 있음 

![](https://t1.daumcdn.net/cfile/tistory/99270C3E5C0D1ED70D)

```
# 방법1 : JOIN와 UINION
SELECT *
FROM table1
  LEFT OUTER JOIN table2
    ON table1.n = table2.n
UNION
SELECT *
FROM table1
  RIGHT OUTER JOIN table2
    ON table1.n = table2.n;

# 방법2 : UNION ALL and exclusion join
SELECT *
FROM table1
  LEFT OUTER JOIN table2
    ON table1.n = table2.n
UNION ALL
SELECT *
FROM table1
  RIGHT OUTER JOIN table2
    ON table1.n = table2.n
WHERE table1.n IS null;
```

##### 셀프 조인 **(SELF JOIN)**

셀프 조인은 자기 자신과 조인

```
SELECT A.first_name AS EmployeeName1, B.first_name AS EmployeeName2, A.dept_no
FROM employees AS A, employees AS B
WHERE A.emp_no <> B.emp_no
AND A.dept_no = B.dept_no;
```

##### 안티 조인 **(SELF JOIN)**

안티 조인은 서브 쿼리내에서 존재하지 않는 데이터만 추출하여 메인 쿼리에서 추출하는 조인

```
SELECT *
FROM employees AS e
WHERE emp_no >= 10002
      AND NOT EXISTS(SELECT *
                     FROM departments AS d
                     WHERE e.dept_no = d.dept_no
                           AND d.dept_no >= 2);
```

##### 세미 조인 **(SELF JOIN)**

세미 조인은 안티 조인과 반대로 서브 쿼리 내에서 존재하는 데이터만을 가지고 메인 쿼리에서 추출하는 방식

```
SELECT *
FROM departments as d
WHERE EXISTS(SELECT *
             FROM employees AS e
             WHERE e.dept_no = d.dept_no
                   AND e.emp_no >= 10003);

# IN 사용
SELECT *
FROM departments as d
WHERE d.dept_no IN (SELECT e.dept_no
                    FROM employees AS e
                    WHERE e.emp_no >= 10003);
```





## SQL Injection(SQL 삽입공격)

- 악의적인 사용자가 보안상의 취약점을 이용하여, 임의의 SQL 문을 주입하고 실행

- 데이터베이스가 비정상적인 동작을 하도록 조작하는 행위

- 인젝션 공격은 OWASP Top10 중 첫 번째에 속해 있으며, 공격이 비교적 쉬운 편
  - Open Web Application Security Project에 따라 악용가능성, 탐지가능성 및 영향에 대해 빈도수가 높고 보안상 영향을 크게 줄 수 있는 10가지 웹 애플리케이션 보안 취약점목록

- 공격에 성공할 경우 큰 피해를 입힐 수 있는 공격



 **1.2 공격 종류 및 방법**

**Error based SQL Injection**

**논리적 에러를 이용한 SQL Injection** 

SQL 공격 기법은 여러 가지가 있는데 논리적 에러를 이용한 SQL Injection은 가장 많이 쓰이고, 대중적인 공격 기법



**Union based SQL Injection**

**Union 명령어를 이용한 SQL Injection** 

SQL 에서 Union 키워드는 두 개의 쿼리문에 대한 결과를 통합해서 하나의 테이블로 보여주게 하는 키워드 

정상적인 쿼리문에 Union 키워드를 사용하여 인젝션에 성공하면, 원하는 쿼리문을 실행할 수 있음

Union Injection을 성공하기 위한 두 가지의 조건

두 테이블의 컬럼 수가 같아야 함

데이터 형이 같아야 함

 

**Blind SQL Injection**

**Boolean based SQL**

Blind SQL Injection은 데이터베이스로부터 특정한 값이나 데이터를 전달받지 않고, 단순히 참과 거짓의 정보만 알 수 있을 때 사용

로그인 폼에 SQL Injection이 가능하다고 가정 했을 때, 서버가 응답하는 로그인 성공과 로그인 실패 메시지를 이용하여, DB의 테이블 정보 등을 추출할 수 있음

 

**Blind SQL Injection**

**Time based SQL**

Time Based SQL Injection는 서버로부터 특정한 응답 대신에 참 혹은 거짓의 응답을 통해서 데이터베이스의 정보를 유추하는 기법

 

**Stored Procedure SQL Injection**

**저장된 프로시저 에서의 SQL Injection**

저장 프로시저(Stored Procedure) 은 일련의 쿼리들을 모아 하나의 함수처럼 사용하기 위한 것

공격에 사용되는 대표적인 저장 프로시저는 MS-SQL 에 있는 xp_cmdshell로 윈도우 명령어를 사용할 수 있게 됨

단, 공격자가 시스템 권한을 획득 해야 하므로 공격난이도가 높으나 공격에 성공한다면, 서버에 직접적인 피해를 입힐 수 있는 공격



**Mass SQL Injection**

**다량의 SQL Injection 공격**

2008년에 처음 발견된 공격기법으로 기존 SQL Injection 과 달리 한번의 공격으로 다량의 데이터베이스가 조작되어 큰 피해를 입히는 것을 의미

보통 MS-SQL을 사용하는 ASP 기반 웹 애플리케이션에서 많이 사용되며, 쿼리문은 HEX 인코딩 방식으로 인코딩 하여 공격

보통 데이터베이스 값을 변조하여 데이터베이스에 악성스크립트를 삽입하고, 사용자들이 변조된 사이트에 접속 시 좀비PC로 감염시킴 

이렇게 감염된 좀비 PC들은 DDoS 공격에 사용



**1.3 대응방안**

**입력 값에 대한 검증**

사용자의 입력 값에 대한 검증이 필요 

서버 단에서 화이트리스트 기반으로 검증해야 함

블랙리스트 기반으로 검증하게 되면 수많은 차단리스트를 등록해야 하고, 하나라도 빠지면 공격에 성공하게 되기 때문

공백으로 치환하는 방법도 많이 쓰이는데, 이 방법도 취약한 방법

 

**Prepared Statement 구문사용**

사용자의 입력 값이 데이터베이스의 파라미터로 들어가기 전에DBMS가 미리 컴파일 하여 실행하지 않고 대기

사용자의 입력 값을 문자열로 인식하게 하여 공격쿼리가 들어간다고 해도 사용자의 입력은  의미 없는 단순 문자열 이기 때문에 전체 쿼리문도 공격자의 의도대로 작동하지 않음.

 

**Error Message 노출 금지**

공격자가 SQL Injection을 수행하기 위해서는 데이터베이스의 정보(테이블명, 컬럼명 등)가 필요

데이터베이스 에러 발생 시 따로 처리를 해주지 않았다면, 에러가 발생한 쿼리문과 함께 에러에 관한 내용을 반환해 줌

여기서 테이블명 및 컬럼명 그리고 쿼리문이 노출이 될 수 있기 때문에, 데이터 베이스에 대한 오류발생 시 사용자에게 보여줄 수 있는 페이지를 제작 혹은 메시지박스를 띄우도록 해야함



**웹 방화벽 사용**

웹 공격 방어에 특화되어있는 웹 방화벽을 사용하는 것도 방법

웹 방화벽은 소프트웨어 형, 하드웨어 형, 프록시 형 이렇게 세가지 종류로 나눌 수 있음

소프트웨어 형은 서버 내에 직접 설치하는 방법이고, 하드웨어 형은 네트워크 상에서 서버 앞 단에 직접 하드웨어 장비로 구성하는 것

프록시 형은 DNS 서버 주소를 웹 방화벽으로 바꾸고 서버로 가는 트래픽이 웹 방화벽을 먼저 거치도록 하는 방법

[참고]

https://advenoh.tistory.com/23

https://noirstar.tistory.com/264