# 5주차 CS 발표

## 세마포어(Semaphore) & 뮤텍스(Mutex)

### 세마포어

공유된 자원에 여러 프로세스가 동시에 접근하면서 문제가 발생할 수 있음. 이때 공유된 자원의 데이터는 한 번에 하나의 프로세스만 접근할 수 있도록 제한을 둬야함

이를 위해 나온 것이 **세마포어**



### 세마포어의 개념도

최초의 s값은 1</br>
P(s)를 먼저 수행하는 프로세스가 s=0 변경</br>
Critical Section에 진입</br>
먼저 들어갔던 프로세스가 V(s)를 수행하면 s=1로 변경</br>
P(s)에서 대기하고있던 프로세스가 진행

> s=1이면, Critical Section에서 실행 중 프로세스인 없음 의미
>
> s=0이면, Critical Section에서 실행 중인 프로세스 있음 의미

![img](http://blog.skby.net/blog/wp-content/uploads/2019/03/%EC%84%B8%EB%A7%88%ED%8F%AC%EC%96%B4-%EA%B0%9C%EB%85%90%EB%8F%842.png)



### 세마포어의 구성 및 구현

>  P연산과 V연산으로 이루어짐
>
> - 아래는 세마포어 카운트를 1로 가정
> - 세마포어의 카운트는 1 이상이며 카운트를 조절하여 진입 가능한 프로세스/스레드 수 조절 가능

#### P연산(Wait)
임계 구역 들어가기 전에 수행 (프로세스 진입 여부를 자원의 개수(S)를 통해 결정)

```
procedure P(S)
while S=0 do wait
S := S-1
end P
```

1. 최초 S값은 1
2. S가 1이면
   - 0으로 만들고 진입
3. S가 0이면
   - S가 1이 될 때까지 기다림

#### V연산(Signal)

임계 구역에서 나올 때 수행 (자원 반납 알림, 대기 중인 프로세스를 깨우는 신호)

```
procedure V(S)		// 현재 상태는 S가 0 
S := S+1	        // S를 1로 원위치시켜 해제하는 과정
end V			// 이제는 다른 프로세스가 들어올 수 있음
```

최초 S값을 1로 만듦

#### 구현 방법

```
P(S);
------------------------
위 험 지 역(Critical Section) = 임계영역
------------------------
V(S);
```



이를 통해, 한 프로세스가 P 혹은 V를 수행하고 있는 동안 프로세스가 인터럽트 당하지 않게 됨.</br>
P와 V를 사용하여 임계 영역에 대한 상호배체 구현이 가능하게 되었음



### 세마포어의 유형

|       유형       |                      목적                       |         내용          |
| :--------------: | :---------------------------------------------: | :-------------------: |
| Binary Semaphore |            상호배제, 프로세스 동기화            | 세마포어 플래그 : 0/1 |
| Count Semaphore  | 초기에 동시 진행 가능한 프로세스 개수 정의 가능 |     0, 1, 2, ...      |



### 뮤텍스

임계 영역을 가진 스레드들의 실행시간이 서로 겹치지 않고 각각 단독으로 실행되게 하는 기술

> 상호 배제(**Mut**ual **Ex**clusion)의 약자

해당 접근을 조율하기 위해 lock/unlock 사용

- lock : 현재 임계 구역에 들어갈 권한을 얻어옴 (만약 다른 프로세스/스레드가 임계 구역 수행 중이면 종료할 때까지 대기)
- unlock : 현재 임계 구역을 모두 사용했음을 알림 (대기 중인 다른 프레세서/스레드가 임계 구역에 진입할 수 있음)

뮤텍스는 상태가 0/1로 **이진 세마포어**로 부르기도 함



### 뮤텍스 알고리즘

1. **데커(Dekker) 알고리즘**

   flag와 turn 변수를 통해 임계 구역에 들어갈 프로세스/스레드를 결정하는 방식

   - flag : 프로세스 중 누가 임계영역에 진입할 것인지 나타내는 변수
   - turn : 누가 임계구역에 들어갈 차례인지 나타내는 변수

   ```cpp
   while(true) {
       flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
       while(flag[j]) { // 프로세스 j가 현재 임계 구역에 있는지 확인
           if(turn == j) { // j가 임계 구역 사용 중이면
               flag[i] = false; // 프로세스 i 진입 취소
               while(turn == j); // turn이 j에서 변경될 때까지 대기
               flag[i] = true; // j turn이 끝나면 다시 진입 시도
           }
       }
   }
   
   // ------- 임계 구역 ---------
   
   turn = j; // 임계 구역 사용 끝나면 turn을 넘김
   flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
   ```

   

2. **피터슨(Peterson) 알고리즘**

   데커와 유사하지만, 상대방 프로세스/스레드에게 진입 기회를 양보하는 것에 차이가 있음

   ```cpp
   while(true) {
       flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
       turn = j; // 다른 프로세스에게 진입 기회 양보
       while(flag[j] && turn == j) { // 다른 프로세스가 진입 시도하면 대기
       }
   }
   
   // ------- 임계 구역 ---------
   
   flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
   ```

   

3. **제과점(Bakery) 알고리즘**

   여러 프로세스/스레드에 대한 처리가 가능한 알고리즘. 가장 작은 수의 번호표를 가지고 있는 프로세스가 임계 구역에 진입함

   ```cpp
   while(true) {
       
       isReady[i] = true; // 번호표 받을 준비
       number[i] = max(number[0~n-1]) + 1; // 현재 실행 중인 프로세스 중에 가장 큰 번호 배정 
       isReady[i] = false; // 번호표 수령 완료
       
       for(j = 0; j < n; j++) { // 모든 프로세스 번호표 비교
           while(isReady[j]); // 비교 프로세스가 번호표 받을 때까지 대기
           while(number[j] && number[j] < number[i] && j < i);
           
           // 프로세스 j가 번호표 가지고 있어야 함
           // 프로세스 j의 번호표 < 프로세스 i의 번호표
       }
   }
   
   // ------- 임계 구역 ---------
   
   number[i] = 0; // 임계 구역 사용 종료
   ```

   

### 세마포어와 뮤텍스의 비교

#### 세마포어와 뮤텍스 개념

|                     세마포어(Semaphore)                      |                        뮤텍스(Mutex)                         |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![img](http://blog.skby.net/blog/wp-content/uploads/2019/03/2-8.png) | ![img](http://blog.skby.net/blog/wp-content/uploads/2019/03/3-6.png) |
| 사용 자원을 **카운트**하며, <br />모든 자원이 사용되면 카운트 0 | 자원을 **한 프로세스**만 할당. <br />종료 시 다음 프로세스 할당 |

#### 세마포어와 뮤텍스 비교

| 항목 | 세마포어                                                     | 뮤텍스                                                       |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 원리 | 화장실이 n칸 (접근 가능 최대 허용치 만큼 동시 사용자 접근 가능)<br />세마포어 카운트가 0이면 대기 | 화장실에 들어가기 위한 열쇠를 한 사람이 가지고 있다면, 그 사람만이 들어갈 수 있음.<br />대기열(큐) 기다리게 됨 → 세마포어의 일종 |
| 목적 | Dead Lock을 피하기 위한 기술 중 하나                         | Critical Section을 가진 Thread들이 running time이 서로 겹치지 않게, 각 단독 실행 기술 |
| 특징 | 공유 리소스에 접근할 수 있는 최대 허용치만큼 동시 사용자 접근을 할 수 있게 하는 기술.<br />동기화 대상이 여러 개일 경우 사용 | 뮤텍스는 제어되는 섹션에 하나의 Thread만을 허용하기 때문에 해당 섹션에 접근하려는 다른 Thread들을 강제적으로 막아 첫번째 Thread가 세션 빠져 나올 때까지 대기 |



---

[참고 1] : <https://itwiki.kr/w/%EC%84%B8%EB%A7%88%ED%8F%AC%EC%96%B4>

[참고 2] : <http://blog.skby.net/%EC%84%B8%EB%A7%88%ED%8F%AC%EC%96%B4-semaphore/>

[참고 3] : <https://gyoogle.dev/blog/computer-science/operating-system/Semaphore%20&%20Mutex.html>
