## Stored Procedure(저장 프로시저)란?

**Stored Procedure(이하 SP) 란?**

DB 내부에 저장된 일련의 SQL 명령문들을 하나의 함수처럼 실행하기 위한 쿼리의 집합

 

**SP의 장점들**

**개발측면**

1. 반복적인 작업을 피할 수 있다.

같은 쿼리 여러 줄을 쓰지 않아도 된다.

2. 개발 언어에 비의존적이다.

msSql을 사용하고 있다고 하자. msSql에서 사용할 수 있는 쿼리문으로 저장 프로시저를 만

들어 놨다면 개발 언어가 바뀌었을 때 저장 프로시저 내용을 바꿀 필요는 없다. 어떤 식으로

필요한 sp를 가져올 수 있는지만 알면 된다.

3. 확장 및 유지 보수가 간편해 진다.

DB관련 작업을 수정할 때 저장 프로시저만 건드리면 되기 때문이다.

4. 프로그램 에러 확률이 크게 줄어든다.

 

**성능 측면**

1. SP는 최적화 되고 캐쉬 된다.

![img](https://t1.daumcdn.net/cfile/tistory/24400142554F2D9F03)

SP는 최초 실행될 때 최적화된 상태로 컴파일이 되고 이후에 DB에 캐쉬되어 저장된다.

캐쉬에 저장되면 최적화와 컴파일 작업을 다시 하지 않는다. 따라서 하나의 SP가 여러 번 쓰

일 때 성능에 향상이 있다.

 

2. 네트워크 트래픽을 감소 시킨다.

SP를 사용하면 SQL문이 서버에 저장된다. SP를 사용하면 수백개의 SQL문이 필요한 일도

서버에서 SP로 처리 하기 때문에 쿼리문 자체를 전달하지 않아도 된다. 이 때 각각의 클라이

언트는 매개변수만 전달한다.

 

**보안측면**

SP에서 참조하고 있는 테이블에 접근을 허용하지 않을 수 있다. 내부적으로 Update하는

쿼리를 가진 SP의 경우 민감할 수 있다. 무기, 레벨, 재화 등등의 저장을 SP를 통해서만

하게 하면 외부의 조작으로부터 하나의 보호막을 만들 수 있는 것이다.

 

**SP의 단점**

- 개발 측면

1. 유지보수가 어렵다.

데이터 분석이 까다롭고 하나의 프로시저를 여러 곳에서 사용했을 경우 영향도 분석이 어렵다.

2. DB 확장이 매우 힘들다.

서비스 사용자가 많아져 서버의 수를 늘려야할 때, DB의 수를 늘리는 것이 더 어렵다. 또한, DB 교체는 거의 불가능해진다.



## 레디스란?

Redis(레디스)는 **REmote DIctionary Server**의 약자로 오픈소스(BSD licensed) DBMS입니다.

In-memory(인메모리) 데이터 저장소이며, Key-Value기반의 NoSQL DBMS입니다.

보통 DB, Cache(캐시), 메시지 브로커 등의 용도로 사용합니다.

> For instance, using pipelining Redis running on an average Linux system can deliver even 1 million requests per second.

초당 10만 ~ 15만건의 명령을 수행할 수 있으며, 위 공식문서의 내용처럼 파이프링을 통해

리눅스시스템에서 초당 100만건의 요청도 수행이 가능하다고 합니다.

### 용어

1. RSS (Resident Set Size)

   실제 메모리 사용

2. AOF (Append Only File)

   명령이 발생할 때마다 기록하는 장소

   서버가 재시작 할 시 write/update를 순차적으로 재실행, 데이터를 복

3. COW (Copy On Write)

   레디스가 데이터를 쓰기 위해 사용하는 매커니즘

------

## 레디스의 특징

1. 싱글스레드 기반 명령 수행

   이를 통해 **Atomic operations**을 보장하며 **Concurrency(동시성)**를 지원합니다.

2. Key-Value 기반으로 데이터 저장

3. 다양한 DataType 지원

   레디스는 비슷한 NoSQL DBMS대비 다양한 타입을 제공합니다.

   (`strings`, `hashes`, `lists`, `sets`, `sorted sets`,

   `bitmaps`, `hyperloglogs`, `geospatial indexes`, `streams`)

   이를 이용하여 **개발 편의성을 극대화** 할 수 있습니다.

   `Lists`의 경우 일반적인 RDB와 비교하면 10배 빠른 속도를 지원합니다.

4. Master-Slave 구성이 가능

   Master-Slave와 같은 **Redis Replication** 뿐만 아니라 **Redis cluster**를 이용한 분산처리, **Redis Sentinel**을 이용한 장애복구 시스템을 제공합니다.

### Copy On Write

레디스의 프로세스들은 Resource(자원)을 공유하고 있습니다.

데이터에 대한 Write(쓰기)명령이 발생하면 프로세스는 `fork()`되고 쓰기 대상이 되는 자원을 `Copy`한 뒤 명령을 수행합니다.

이와 같은 특징 때문에 레디스는 메모리공간을 2배로 사용하게 되며, 메모리 파편화가 발생하기 쉽습니다.

![cow](https://akasai.space/static/d931e42970298c60f19cf8805b8cca19/748f4/cow.png)

**COW**가 발생하는 상황은 다음과 같습니다.

1. save 파라미터 (RDB 파일)
2. BGSAVE 명령 (RDB 파일)
3. 복제 Replication (RDB 파일)
4. auto-aof-rewrite-percentage 파라미터 (AOF)
5. BGREWRITEAOF 명령 (AOF)

------

## 주의할 명

### keys

레디스에 존재하는 모든 key를 조회. (레디스 매뉴얼에도 운영환경에서는 사용하지 말 것을 권고함)

`scan`을 통해 순회 탐색으로 전체 key 조회

### smem

`Sets` 자료구조의 모든 member들을 조회.

`sscan`을 통한 순회 탐색으로 전체 member 조회

### flushall

전체 데이터를 지우는 명령어로, 키 갯수에 비례한 수행시간

------

## 요약

레디스는 빠른속도와 강력한 기능을 제공하는 만큼 사용시 주의를 기울여야하는 저장소입니다.

중요기능에 사용되는 만큼 Critical한 장애가 발생할 수 있기 때문입니다.



참고

https://itability.tistory.com/51

https://akasai.space/redis/about_redis_1/
