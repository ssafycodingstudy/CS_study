## [TCP] 3 way handshake & 4 way handshake

### 3-way Handshake란?

- TCP는 장치들 사이에 논리적인 접속을 성립(establish) 하기 위해 3-way handshake 사용

- TCP/IP 프로토콜 이용해 통신 하는 응용프로그램이 데이터를 전송하기 전에 먼저 정확한 전송 보장 하기 위하여 상대방 컴퓨터와 사전에 세션을 수립하는 과정



### 역할

- 양쪽 모두 데이터를 전송할 준비가 됐다는 것을 보장하고, 실제로 데이터 전달이 시작하기 전에 반대 쪽이 준비되었다는 것을 알 수 있게 함
- 양쪽 모두 상대편에 대한 초기 순차 일련번호를 얻을 수 있음

![1](https://user-images.githubusercontent.com/44665707/153370506-e38f6f4a-16ea-4bb1-b8f9-71453f33a3e1.PNG)

### 과정

- A클라이언트가 B서버에 접속 요청하는 SYN 패킷을 보냄. A클라이언트는 SYN을 보내고 SYN/ACK 응답을 기다리는 SYN_SENT 상태가 됨

- B서버는 SYN 요청을 받고 A클라이언트에게 요청을 수락한다는 ACK와 SYN flag가 설정된 패킷을 발송하고 A가 다시 ACK로 응답하기를 기다림. 이때 B서버는 SYN_RECEIVED 상태가 됨
- A클라이언트는 B서버에게 ACK를 보내고 이후 연결이 이루어져 데이터가 오갈 수 있게 됨. 이후에 상태는 둘다 ESTABLISHED

SYN : synchronize sequnce numbers

ACK : acknowledgment



---

### 4-way Handshake

- 3-way Handshake가 TCP의 연결을 초기화 할때 사용한다면, 4-way Handshake는 세션 종료 위해 수행

![2](https://user-images.githubusercontent.com/44665707/153371954-32893dd2-9e47-4373-82b8-6a715a021146.PNG)

### 과정

- 클라이언트가 연결을 종료하겠다는 FIN 플래그 전송
- 서버는 일단 확인메시지를 보내고 자신의 통신이 끝날때까지 기다리는데 이 상태가 CLOSE_WAIT 상태
- 서버가 통신 끝나면 연결 종료되었다고 클라이언트에게 FIN플래그 전송
- 클라이언트는 확인했다는 메시지 보냄

- 클라이언트에서 세션을 종료시킨 후 늦게 도착하는 패킷이 Drop(유실) 됨을 방지하기 위해 FIN을 수신하고도 일정시간(디폴트 240초)동안 세션을 남겨놓고 잉여 패킷을 기다리는데, 이 과정을 TIME_WAIT 라고 함